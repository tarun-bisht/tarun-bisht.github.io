<!DOCTYPE html>
<html lang="en">
<head>
	
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,shrink-to-fit=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="HandheldFriendly" content="true">
	<meta name="color-scheme" content="dark light">

	<link rel="stylesheet" href="/assets/css/style.css">
	<script src="/assets/js/dark_mode.min.js"></script>
	<link rel="icon" href="/assets/images/favicon.ico">
	<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>PyTorch RCNN Tutorial: Dive into Object Detection with RCNN | Tarun Bisht</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="PyTorch RCNN Tutorial: Dive into Object Detection with RCNN" />
<meta name="author" content="Tarun Bisht" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this tutorial, we will delve into the intricacies of object detection using RCNN (Region-based Convolutional Neural Networks). Object detection is a fundamental task in computer vision, pivotal for applications like autonomous driving, surveillance, and image analysis. RCNN stands out as a pioneering approach in this field, which uses deep neural networks. RCNN uses selective search algorithm for generating region proposals by merging similar pixels into regions. The regions got from this step were warped, resized and preprocessed then passed into a CNN which produces feature vectors these feature vectors are then used for classification and bounding box regression which result bounding boxes of objects and their classes." />
<meta property="og:description" content="In this tutorial, we will delve into the intricacies of object detection using RCNN (Region-based Convolutional Neural Networks). Object detection is a fundamental task in computer vision, pivotal for applications like autonomous driving, surveillance, and image analysis. RCNN stands out as a pioneering approach in this field, which uses deep neural networks. RCNN uses selective search algorithm for generating region proposals by merging similar pixels into regions. The regions got from this step were warped, resized and preprocessed then passed into a CNN which produces feature vectors these feature vectors are then used for classification and bounding box regression which result bounding boxes of objects and their classes." />
<link rel="canonical" href="https://tarunbisht.com/deep%20learning/2024/03/24/pytorch-rcnn-tutorial-object-detection/" />
<meta property="og:url" content="https://tarunbisht.com/deep%20learning/2024/03/24/pytorch-rcnn-tutorial-object-detection/" />
<meta property="og:site_name" content="Tarun Bisht" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-24T06:05:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PyTorch RCNN Tutorial: Dive into Object Detection with RCNN" />
<meta name="twitter:site" content="@tarunresearches" />
<meta name="twitter:creator" content="@Tarun Bisht" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Tarun Bisht"},"headline":"PyTorch RCNN Tutorial: Dive into Object Detection with RCNN","dateModified":"2024-03-24T06:05:00+00:00","datePublished":"2024-03-24T06:05:00+00:00","description":"In this tutorial, we will delve into the intricacies of object detection using RCNN (Region-based Convolutional Neural Networks). Object detection is a fundamental task in computer vision, pivotal for applications like autonomous driving, surveillance, and image analysis. RCNN stands out as a pioneering approach in this field, which uses deep neural networks. RCNN uses selective search algorithm for generating region proposals by merging similar pixels into regions. The regions got from this step were warped, resized and preprocessed then passed into a CNN which produces feature vectors these feature vectors are then used for classification and bounding box regression which result bounding boxes of objects and their classes.","url":"https://tarunbisht.com/deep%20learning/2024/03/24/pytorch-rcnn-tutorial-object-detection/","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://tarunbisht.com/assets/images/logo_primary.svg"},"name":"Tarun Bisht"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tarunbisht.com/deep%20learning/2024/03/24/pytorch-rcnn-tutorial-object-detection/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

	
</head>
<body>
    
    <section class="writing-header">
	<div class="header">
		<nav>
	<div class="logo"></div>
	<div class="menu-btn">
		<div class="line1"></div>
		<div class="line2"></div>
		<div class="line3"></div>
	</div>
    <ul class="menu">
        <li><a href="/"> Home</a></li>
        <li><a href="/about/"> About</a></li>
        <li><a href="/blogs/"> Blogs</a></li>
        <li><a href="/projects/">Projects</a></li>
        <li><a href="/cv/">CV</a></li>
        <li><a href="/resume/">Resume</a></li>
        <li><a href="/contact/"> Contact</a></li>
        <li class="switch"><span></span><input type="checkbox" id="switch"/><label for="switch">Toggle</label></li>
	</ul>
</nav>
	</div>
</section>

<section class="writing-body">
	<div class="container">
    	<div class="markdown-html">
			<h1 class="headline">PyTorch RCNN Tutorial: Dive into Object Detection with RCNN</h1>
            <p>Object detection is a computer vision task where given an image we have to find objects positions and classify detected objects into different categories.</p>

<p><img src="/assets/blogs/rcnn/img_1.png" alt="image.png" /></p>

<blockquote>
  <p><a href="https://pjreddie.com/darknet/yolov1/">Reference</a></p>
</blockquote>

<p>In object detection we are trying to solve two tasks:</p>

<ul>
  <li>Object localisation</li>
  <li>Classification</li>
</ul>

<p><img src="/assets/blogs/rcnn/obj_detection_chart.png" alt="obj_detection_chart.png" /></p>

<h2 id="installing-and-importing-dependencies">Installing and Importing dependencies</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="c1"># kaggle for loading preprocessed dataset
</span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">kaggle</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="c1"># mounting google drive for loading kaggle api .json file
</span><span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="p">.</span><span class="n">mount</span><span class="p">(</span><span class="s">"/content/drive"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="loading-and-exploring-data">Loading and Exploring data</h2>

<p>We will be using Pascal VOC dataset 2007 version. It provides standardised image data sets for object class recognition. More information about dataset can be accesed at this <a href="http://host.robots.ox.ac.uk/pascal/VOC/">url</a>. We will be using <code class="language-html highlighter-rouge">torchvision.datasets.VOCDetection</code> to load the dataset.</p>

<h3 id="loading-dataset">Loading dataset</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="c1"># loading detection data
</span><span class="n">voc_dataset_train</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">VOCDetection</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">"content/voc"</span><span class="p">,</span>
                                                <span class="n">image_set</span><span class="o">=</span><span class="s">"train"</span><span class="p">,</span>
                                                <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">year</span><span class="o">=</span><span class="s">"2007"</span><span class="p">)</span>
<span class="n">voc_dataset_val</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">VOCDetection</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">"content/voc"</span><span class="p">,</span>
                                                <span class="n">image_set</span><span class="o">=</span><span class="s">"val"</span><span class="p">,</span>
                                                <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">year</span><span class="o">=</span><span class="s">"2007"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Downloading http://host.robots.ox.ac.uk/pascal/VOC/voc2007/VOCtrainval_06-Nov-2007.tar to content/voc/VOCtrainval_06-Nov-2007.tar


    100%|██████████| 460032000/460032000 [00:14&lt;00:00, 31429061.40it/s]


    Extracting content/voc/VOCtrainval_06-Nov-2007.tar to content/voc
    Using downloaded and verified file: content/voc/VOCtrainval_06-Nov-2007.tar
    Extracting content/voc/VOCtrainval_06-Nov-2007.tar to content/voc
</code></pre>

<h3 id="exploring-data">Exploring Data</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">voc_dataset_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    (&lt;PIL.Image.Image image mode=RGB size=500x333&gt;,
     {'annotation': {'folder': 'VOC2007',
       'filename': '000012.jpg',
       'source': {'database': 'The VOC2007 Database',
        'annotation': 'PASCAL VOC2007',
        'image': 'flickr',
        'flickrid': '207539885'},
       'owner': {'flickrid': 'KevBow', 'name': '?'},
       'size': {'width': '500', 'height': '333', 'depth': '3'},
       'segmented': '0',
       'object': [{'name': 'car',
         'pose': 'Rear',
         'truncated': '0',
         'difficult': '0',
         'bndbox': {'xmin': '156', 'ymin': '97', 'xmax': '351', 'ymax': '270'}}]}})
</code></pre>
<p>Each sample in dataset is a tuple with two elements (index 0: image, index 1: annotations)
We will be only using object annotation information which is list of dictionary that contain information about object class and its bounding box.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">print</span><span class="p">(</span><span class="s">"Sample Image shape: "</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">voc_dataset_train</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]).</span><span class="n">shape</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Sample Image shape:  (333, 500, 3)
</code></pre>
<p>Image shapes in pascal dataset are not uniform it contains images of different sizes.</p>

<p>Next we will find all unique object classes present in the dataset.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">all_objs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">voc_dataset_train</span><span class="p">:</span>
    <span class="n">obj_annots</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">"annotation"</span><span class="p">][</span><span class="s">"object"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj_annots</span><span class="p">:</span>
        <span class="n">all_objs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s">"name"</span><span class="p">])</span>

<span class="n">unique_class_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_objs</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Number of unique objects in dataset: "</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_class_labels</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Unique labels in dataset: </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">unique_class_labels</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Number of unique objects in dataset:  20
    Unique labels in dataset:
     {'diningtable', 'pottedplant', 'train', 'cat', 'cow', 'tvmonitor', 'bottle', 'bicycle', 'motorbike', 'aeroplane', 'bus', 'car', 'sofa', 'chair', 'sheep', 'bird', 'boat', 'person', 'horse', 'dog'}
</code></pre>
<p>Next we will create two dictionaries one will map class labels into integer and another maps integer into class labels.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="n">label_2_idx</span> <span class="o">=</span> <span class="p">{</span><span class="s">'pottedplant'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'person'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
               <span class="s">'motorbike'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'train'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
               <span class="s">'dog'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">'diningtable'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
               <span class="s">'horse'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">'bus'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
               <span class="s">'aeroplane'</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s">'sofa'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
               <span class="s">'sheep'</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s">'tvmonitor'</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
               <span class="s">'bird'</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s">'bottle'</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
               <span class="s">'chair'</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s">'cat'</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
               <span class="s">'bicycle'</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s">'cow'</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
               <span class="s">'boat'</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="s">'car'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s">'bg'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">idx_2_label</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">'pottedplant'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">'person'</span><span class="p">,</span>
               <span class="mi">3</span><span class="p">:</span> <span class="s">'motorbike'</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">'train'</span><span class="p">,</span>
               <span class="mi">5</span><span class="p">:</span> <span class="s">'dog'</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s">'diningtable'</span><span class="p">,</span>
               <span class="mi">7</span><span class="p">:</span> <span class="s">'horse'</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s">'bus'</span><span class="p">,</span>
               <span class="mi">9</span><span class="p">:</span> <span class="s">'aeroplane'</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="s">'sofa'</span><span class="p">,</span>
               <span class="mi">11</span><span class="p">:</span> <span class="s">'sheep'</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s">'tvmonitor'</span><span class="p">,</span>
               <span class="mi">13</span><span class="p">:</span> <span class="s">'bird'</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="s">'bottle'</span><span class="p">,</span>
               <span class="mi">15</span><span class="p">:</span> <span class="s">'chair'</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span> <span class="s">'cat'</span><span class="p">,</span>
               <span class="mi">17</span><span class="p">:</span> <span class="s">'bicycle'</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span> <span class="s">'cow'</span><span class="p">,</span>
               <span class="mi">19</span><span class="p">:</span> <span class="s">'boat'</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span> <span class="s">'car'</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s">'bg'</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="c1"># img: image as np array
# boxes: [[xmin, y_min, x_max, y_max]]
# labels: labels present in bounding boxes
# scores: array of probabilities that given object is present in bounding boxes.
# class_map: dictionary that maps index to class names
</span><span class="k">def</span> <span class="nf">draw_boxes</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">class_map</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nums</span><span class="p">):</span>
        <span class="n">x1y1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">x2y2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">x1y1</span><span class="p">,</span> <span class="n">x2y2</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">class_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label_txt</span> <span class="o">=</span> <span class="n">class_map</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">putText</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="s">"{} {:.4f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">label_txt</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="n">x1y1</span><span class="p">,</span>
            <span class="n">cv2</span><span class="p">.</span><span class="n">FONT_HERSHEY_COMPLEX_SMALL</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>we will plot one image along with true bounding boxes using <code class="language-html highlighter-rouge">draw_boxes</code> function.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">sample_image</span><span class="p">,</span> <span class="n">sample_annot</span> <span class="o">=</span> <span class="n">voc_dataset_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_image</span><span class="p">)</span>
<span class="n">sample_annot</span> <span class="o">=</span> <span class="n">sample_annot</span><span class="p">[</span><span class="s">"annotation"</span><span class="p">][</span><span class="s">"object"</span><span class="p">]</span>
<span class="n">boxes</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s">"bndbox"</span><span class="p">].</span><span class="n">items</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sample_annot</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_2_idx</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">"name"</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sample_annot</span><span class="p">]</span>
<span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">final_image</span> <span class="o">=</span> <span class="n">draw_boxes</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">idx_2_label</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/assets/blogs/rcnn/output_21_0.png" alt="png" /></p>

<p>We have defined <code class="language-html highlighter-rouge">calculate_iou_score</code> that takes two bounding boxes as parameters and calculate intersection over union (iou) score between those boxes.</p>

<p><img src="/assets/blogs/rcnn/img_2.png" alt="image.png" /></p>

<blockquote>
  <p><a href="https://en.wikipedia.org/wiki/Jaccard_index">Reference</a></p>
</blockquote>

<p><img src="/assets/blogs/rcnn/img_3.png" alt="image.png" /></p>

<blockquote>
  <p><a href="https://en.wikipedia.org/wiki/Jaccard_index">Reference</a></p>
</blockquote>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">calculate_iou_score</span><span class="p">(</span><span class="n">box_1</span><span class="p">,</span> <span class="n">box_2</span><span class="p">):</span>
    <span class="s">'''
        box_1 = single of ground truth bounding boxes
        box_2 = single of predicted bounded boxes
    '''</span>
    <span class="n">box_1_x1</span> <span class="o">=</span> <span class="n">box_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">box_1_y1</span> <span class="o">=</span> <span class="n">box_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">box_1_x2</span> <span class="o">=</span> <span class="n">box_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">box_1_y2</span> <span class="o">=</span> <span class="n">box_1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">box_2_x1</span> <span class="o">=</span> <span class="n">box_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">box_2_y1</span> <span class="o">=</span> <span class="n">box_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">box_2_x2</span> <span class="o">=</span> <span class="n">box_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">box_2_y2</span> <span class="o">=</span> <span class="n">box_2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">box_1_x1</span><span class="p">,</span> <span class="n">box_2_x1</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">box_1_y1</span><span class="p">,</span> <span class="n">box_2_y1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">box_1_x2</span><span class="p">,</span> <span class="n">box_2_x2</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">box_1_y2</span><span class="p">,</span> <span class="n">box_2_y2</span><span class="p">)</span>

    <span class="n">area_of_intersection</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">area_box_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_1_x2</span> <span class="o">-</span> <span class="n">box_1_x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">box_1_y2</span> <span class="o">-</span> <span class="n">box_1_y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">area_box_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_2_x2</span> <span class="o">-</span> <span class="n">box_2_x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">box_2_y2</span> <span class="o">-</span> <span class="n">box_2_y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">area_of_union</span> <span class="o">=</span> <span class="n">area_box_1</span> <span class="o">+</span> <span class="n">area_box_2</span> <span class="o">-</span> <span class="n">area_of_intersection</span>

    <span class="k">return</span> <span class="n">area_of_intersection</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">area_of_union</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="rcnn">RCNN</h2>

<p><img src="/assets/blogs/rcnn/img_4.png" alt="image.png" /></p>
<blockquote>
  <p><a href="https://arxiv.org/pdf/1311.2524.pdf">Reference</a></p>
</blockquote>

<p>RCNN uses selective search algorithm for generating region proposals by merging similar pixels into regions. The regions got from this step were warped, resized and preprocessed then passed into a CNN which produces feature vectors these feature vectors are then used for classification and bounding box regression which result bounding boxes of objects and their classes. RCNN yields a significant performance boost on VOC07 dataset, with a large improvement of mean Average Precision (mAP) from 33.7% in DPM-v5 to 58.5%.This algorithm was fast with respect to sliding window approach and then passing each window to CNN but it was still quite slow to be used in realtime object detection.</p>

<h3 id="steps-to-train-rcnn">Steps to Train RCNN</h3>

<ul>
  <li>We apply selective search algorithm to find box proposals</li>
  <li>We take those boxes in the dataset whose iou_score(proposed_box, true_box) &gt; threshold.</li>
  <li>We also save some boxes with no objects and label them 0 (background). These will be useful while training classifier.</li>
  <li>We then train a CNN based model in the prepared dataset.</li>
</ul>

<h3 id="steps-for-inference-with-rcnn">Steps for inference with RCNN</h3>

<ul>
  <li>We first apply selective search algorithm to image</li>
  <li>Pass all proposed bounding boxes to trained CNN model we get using above step.</li>
  <li>Postprocessing outputs from model (this include selecting best boxes and applying non max supression we will look these later)</li>
</ul>

<h3 id="creating-dataset-for-training">Creating dataset for training</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">process_data_for_rcnn</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rects</span><span class="p">,</span> <span class="n">class_map</span><span class="p">,</span> <span class="n">boxes_annots</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">,</span> <span class="n">max_boxes</span><span class="p">):</span>
    <span class="n">true_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">image_sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">true_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">false_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">boxes_annots</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">[</span><span class="s">"bndbox"</span><span class="p">].</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">:</span>
            <span class="n">iou_score</span> <span class="o">=</span> <span class="n">calculate_iou_score</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_score</span> <span class="o">&gt;</span> <span class="n">iou_threshold</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">true_count</span> <span class="o">&lt;</span> <span class="n">max_boxes</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">true_classes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_map</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">rect</span>
                    <span class="n">img_section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="n">x2</span><span class="p">]</span>
                    <span class="n">image_sections</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_section</span><span class="p">)</span>
                    <span class="n">true_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">false_count</span> <span class="o">&lt;</span> <span class="n">max_boxes</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">true_classes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">rect</span>
                    <span class="n">img_section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="n">x2</span><span class="p">]</span>
                    <span class="n">image_sections</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_section</span><span class="p">)</span>
                    <span class="n">false_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">image_sections</span><span class="p">,</span> <span class="n">true_classes</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Creating dataset for RCNN takes some time, we have already created processed version of dataset for RCNN training and provided it through kaggle datasets. The size of preprocessed dataset is approx 5GB.</p>

<p>To download dataset from kaggle we first need to download kaggle api file and then upload it to colab. Saving to google drive and then loading from google drive is recommended.</p>

<h3 id="setting-up-kaggle-api">Setting up kaggle API</h3>

<ol>
  <li>
    <p>Go to your kaggle account, Scroll to API section.</p>
  </li>
  <li>
    <p>Click on Create New Token - It will download kaggle.json file on your machine.</p>
  </li>
</ol>

<p><img src="/assets/blogs/rcnn/img_5.png" alt="image.png" /></p>

<p>Next we need to upload the kaggle.json to google drive or directly to colab and use it to authenticate in kaggle servers.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="err">!</span><span class="n">mkdir</span> <span class="o">~/</span><span class="p">.</span><span class="n">kaggle</span>
<span class="err">!</span><span class="n">cp</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">drive</span><span class="o">/</span><span class="n">MyDrive</span><span class="o">/</span><span class="n">kaggle</span><span class="p">.</span><span class="n">json</span> <span class="o">~/</span><span class="p">.</span><span class="n">kaggle</span><span class="o">/</span>
<span class="err">!</span><span class="n">chmod</span> <span class="mi">600</span> <span class="o">~/</span><span class="p">.</span><span class="n">kaggle</span><span class="o">/</span><span class="n">kaggle</span><span class="p">.</span><span class="n">json</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now kaggle has been setup in google colab now we can download any kaggle dataset. The preprocessed dataset for RCNN can be found at this <a href="https://www.kaggle.com/datasets/tarunbisht11/rcnn-processed-pickle">link</a></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="err">!</span><span class="n">kaggle</span> <span class="n">datasets</span> <span class="n">download</span> <span class="o">-</span><span class="n">d</span> <span class="n">tarunbisht11</span><span class="o">/</span><span class="n">rcnn</span><span class="o">-</span><span class="n">processed</span><span class="o">-</span><span class="n">pickle</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">max_iou_threshold</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">max_boxes</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">max_selections</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">processed_data_save_path_train</span> <span class="o">=</span> <span class="s">"rcnn-processed-pickle/rcnn_train/rcnn_train"</span>
<span class="n">processed_data_save_path_val</span> <span class="o">=</span> <span class="s">"rcnn-processed-pickle/rcnn_val/rcnn_val"</span>
<span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processed_data_save_path_train</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processed_data_save_path_val</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="n">all_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">processed_data_save_path_train</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">80000</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">voc_dataset_train</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">boxes_annots</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s">"annotation"</span><span class="p">][</span><span class="s">"object"</span><span class="p">]</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">ximgproc</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">createSelectiveSearchSegmentation</span><span class="p">()</span>
        <span class="n">ss</span><span class="p">.</span><span class="n">setBaseImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">ss</span><span class="p">.</span><span class="n">switchToSelectiveSearchFast</span><span class="p">()</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">process</span><span class="p">()[:</span><span class="n">max_selections</span><span class="p">]</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">])</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">process_data_for_rcnn</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                                <span class="n">rects</span><span class="p">,</span>
                                                <span class="n">label_2_idx</span><span class="p">,</span>
                                                <span class="n">boxes_annots</span><span class="p">,</span>
                                                <span class="n">max_iou_threshold</span><span class="p">,</span>
                                                <span class="n">max_boxes</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">all_images</span> <span class="o">+=</span> <span class="n">images</span>
        <span class="n">all_labels</span> <span class="o">+=</span> <span class="n">classes</span>

    <span class="c1"># saving processed data to pickle file
</span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_images</span><span class="p">,</span> <span class="n">all_labels</span><span class="p">)):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">processed_data_save_path_train</span><span class="p">,</span> <span class="sa">f</span><span class="s">"img_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s">.pkl"</span><span class="p">),</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pkl</span><span class="p">:</span>
            <span class="n">pickle</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span><span class="s">"image"</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span> <span class="s">"label"</span><span class="p">:</span> <span class="n">label</span><span class="p">},</span> <span class="n">pkl</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Data Already Prepared."</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Data Already Prepared.
</code></pre>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="n">all_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">processed_data_save_path_val</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">80000</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">voc_dataset_val</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">boxes_annots</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s">"annotation"</span><span class="p">][</span><span class="s">"object"</span><span class="p">]</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">ximgproc</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">createSelectiveSearchSegmentation</span><span class="p">()</span>
        <span class="n">ss</span><span class="p">.</span><span class="n">setBaseImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">ss</span><span class="p">.</span><span class="n">switchToSelectiveSearchFast</span><span class="p">()</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">process</span><span class="p">()[:</span><span class="n">max_selections</span><span class="p">]</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">])</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">process_data_for_rcnn</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                                <span class="n">rects</span><span class="p">,</span>
                                                <span class="n">label_2_idx</span><span class="p">,</span>
                                                <span class="n">boxes_annots</span><span class="p">,</span>
                                                <span class="n">max_iou_threshold</span><span class="p">,</span>
                                                <span class="n">max_boxes</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">all_images</span> <span class="o">+=</span> <span class="n">images</span>
        <span class="n">all_labels</span> <span class="o">+=</span> <span class="n">classes</span>

    <span class="c1"># saving processed data to pickle file
</span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_images</span><span class="p">,</span> <span class="n">all_labels</span><span class="p">)):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">processed_data_save_path_val</span><span class="p">,</span> <span class="sa">f</span><span class="s">"img_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s">.pkl"</span><span class="p">),</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pkl</span><span class="p">:</span>
            <span class="n">pickle</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span><span class="s">"image"</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span> <span class="s">"label"</span><span class="p">:</span> <span class="n">label</span><span class="p">},</span> <span class="n">pkl</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Data Already Prepared."</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Data Already Prepared.
</code></pre>

<h3 id="creating-pytorch-dataset">Creating PyTorch dataset</h3>

<p>We use <code class="language-html highlighter-rouge">torch.utils.data.Dataset</code> to create dataset. This class takes processed data folder generated using above methods.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">RCNNDataset</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processed_data_folder</span><span class="p">,</span> <span class="n">section_dim</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">section_dim</span> <span class="o">=</span> <span class="n">section_dim</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">processed_data_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">processed_data_folder</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="p">.</span><span class="n">data_files</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
                                                           <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_files</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pkl</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">pkl</span><span class="p">)</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">"image"</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">"label"</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">section_dim</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">permute</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>To visualize batches of data we have defined <code class="language-html highlighter-rouge">imshow</code> function that takes batch of images and labels as inputs and plot them in a grid.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="s">"""Display image for Tensor."""</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]).</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]).</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">inp</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="nb">type</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">RCNNDataset</span><span class="p">(</span><span class="n">processed_data_folder</span><span class="o">=</span><span class="n">processed_data_save_path_train</span><span class="p">,</span> <span class="n">section_dim</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">RCNNDataset</span><span class="p">(</span><span class="n">processed_data_folder</span><span class="o">=</span><span class="n">processed_data_save_path_val</span><span class="p">,</span> <span class="n">section_dim</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">print</span><span class="p">(</span><span class="s">"Train Dataset one sample images shape: "</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train Dataset one sample labels shape: "</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train Dataset one sample images dtype: "</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train Dataset one sample labels dtype: "</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train Dataset number of samples: "</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Train Dataset one sample images shape:  torch.Size([3, 224, 224])
    Train Dataset one sample labels shape:  torch.Size([])
    Train Dataset one sample images dtype:  torch.float32
    Train Dataset one sample labels dtype:  torch.int64
    Train Dataset number of samples:  80217
</code></pre>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">print</span><span class="p">(</span><span class="s">"Val Dataset one sample images shape: "</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Val Dataset one sample labels shape: "</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Val Dataset one sample images dtype: "</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Val Dataset one sample labels dtype: "</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Val Dataset number of samples: "</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Val Dataset one sample images shape:  torch.Size([3, 224, 224])
    Val Dataset one sample labels shape:  torch.Size([])
    Val Dataset one sample images dtype:  torch.float32
    Val Dataset one sample labels dtype:  torch.int64
    Val Dataset number of samples:  80139
</code></pre>
<p>Next we have defined torch dataloader for training the model using <code class="language-html highlighter-rouge">torch.utils.data.DataLoader</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_2_label</span><span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">item</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train Batch"</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Train Batch
</code></pre>
<p><img src="/assets/blogs/rcnn/output_45_1.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">val_loader</span><span class="p">))</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_2_label</span><span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">item</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Validation Batch"</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Validation Batch
</code></pre>
<p><img src="/assets/blogs/rcnn/output_46_1.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Using Device: "</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Using Device:  cuda
</code></pre>
<h2 id="training">Training</h2>

<h3 id="defining-model">Defining model</h3>

<p>We defined a function <code class="language-html highlighter-rouge">build_model</code> that takes any resnet architecture defined in <code class="language-html highlighter-rouge">torchvision</code> library and build a model based on number of classes in dataset.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="n">num_ftrs</span> <span class="o">=</span> <span class="n">backbone</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">in_features</span>
    <span class="c1"># num_classes = number of class categories and +1 for background class
</span>    <span class="n">backbone</span><span class="p">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
                                <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_ftrs</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
                                <span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
                                <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">backbone</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We are loading <code class="language-html highlighter-rouge">resent50</code> with pretrained checkpoints which was trained on imagenet. We are also freezing the whole resnet architecture so we will only train the classifier part.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">resnet_backbone</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">resnet50</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s">'IMAGENET1K_V2'</span><span class="p">)</span>
<span class="c1"># freeze pretrained backbone
</span><span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">resnet_backbone</span><span class="p">.</span><span class="n">parameters</span><span class="p">():</span>
    <span class="n">param</span><span class="p">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">backbone</span><span class="o">=</span><span class="n">resnet_backbone</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_class_labels</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    Downloading: "https://download.pytorch.org/models/resnet50-11ad3fa6.pth" to /root/.cache/torch/hub/checkpoints/resnet50-11ad3fa6.pth
    100%|██████████| 97.8M/97.8M [00:00&lt;00:00, 215MB/s]





    ResNet(
      (conv1): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (maxpool): MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)
      (layer1): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
            (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
      )
      (layer2): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
            (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (3): Bottleneck(
          (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
      )
      (layer3): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False)
            (1): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (3): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (4): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (5): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
      )
      (layer4): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False)
            (1): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
          (relu): ReLU(inplace=True)
        )
      )
      (avgpool): AdaptiveAvgPool2d(output_size=(1, 1))
      (fc): Sequential(
        (0): Dropout(p=0.2, inplace=False)
        (1): Linear(in_features=2048, out_features=512, bias=True)
        (2): Dropout(p=0.2, inplace=False)
        (3): Linear(in_features=512, out_features=21, bias=True)
      )
    )
</code></pre>
<p>We have defined class_weights this gives more weightage to classes in dataset and give lower weightage to background class. Then we define cross entropy loss and adam optimizer for training.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">class_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="mf">2.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_class_labels</span><span class="p">)</span> <span class="c1"># 1 for bg and 2 for other classes
</span><span class="n">class_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">class_weights</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">class_weights</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="training-the-model">Training the model</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="code"><pre><span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">best_val_loss</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">epoch_train_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">epoch_val_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_train</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct_train</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total_train</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">correct_train</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">train_losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">accuracy_train</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">correct_train</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_train</span>
    <span class="n">train_accuracy</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_train</span><span class="p">)</span>
    <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>
    <span class="n">epoch_train_losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span>

    <span class="n">val_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct_val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">val_loader</span><span class="p">):</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="n">val_losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">total_val</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">correct_val</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>

    <span class="n">accuracy_val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">correct_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_val</span>
    <span class="n">val_accuracy</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_val</span><span class="p">)</span>
    <span class="n">epoch_val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_losses</span><span class="p">)</span>
    <span class="n">epoch_val_losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_val_loss</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">Epoch: {}/{}, Train Loss: {:.8f}, Train Accuracy: {:.8f}, Val Loss: {:.8f}, Val Accuracy: {:.8f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">epoch_train_loss</span><span class="p">,</span> <span class="n">accuracy_train</span><span class="p">,</span> <span class="n">epoch_val_loss</span><span class="p">,</span> <span class="n">accuracy_val</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">epoch_val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
        <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">epoch_val_loss</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Saving the model state dictionary for Epoch: {} with Validation loss: {:.8f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epoch_val_loss</span><span class="p">))</span>
        <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s">"rcnn_model.pt"</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
</pre></td></tr></tbody></table></code></pre></figure>

<pre><code class="language-txt">    100%|██████████| 2507/2507 [15:12&lt;00:00,  2.75it/s]
    100%|██████████| 1253/1253 [15:33&lt;00:00,  1.34it/s]



    Epoch: 1/100, Train Loss: 0.64668946, Train Accuracy: 86.98405575, Val Loss: 0.45590416, Val Accuracy: 89.13887121
    Saving the model state dictionary for Epoch: 1 with Validation loss: 0.45590416


    100%|██████████| 2507/2507 [08:06&lt;00:00,  5.15it/s]
    100%|██████████| 1253/1253 [07:13&lt;00:00,  2.89it/s]



    Epoch: 2/100, Train Loss: 0.41645256, Train Accuracy: 89.96596731, Val Loss: 0.48327551, Val Accuracy: 89.27363706


    100%|██████████| 2507/2507 [06:44&lt;00:00,  6.19it/s]
    100%|██████████| 1253/1253 [06:47&lt;00:00,  3.08it/s]



    Epoch: 3/100, Train Loss: 0.36805147, Train Accuracy: 90.77252951, Val Loss: 0.45782487, Val Accuracy: 89.73907835


    100%|██████████| 2507/2507 [06:28&lt;00:00,  6.45it/s]
    100%|██████████| 1253/1253 [06:47&lt;00:00,  3.08it/s]



    Epoch: 4/100, Train Loss: 0.34133269, Train Accuracy: 91.15274817, Val Loss: 0.45103499, Val Accuracy: 89.39218109
    Saving the model state dictionary for Epoch: 4 with Validation loss: 0.45103499


    100%|██████████| 2507/2507 [06:32&lt;00:00,  6.39it/s]
    100%|██████████| 1253/1253 [06:56&lt;00:00,  3.01it/s]



    Epoch: 5/100, Train Loss: 0.32376182, Train Accuracy: 91.46315619, Val Loss: 0.60181320, Val Accuracy: 89.54067308


    100%|██████████| 2507/2507 [06:42&lt;00:00,  6.23it/s]
    100%|██████████| 1253/1253 [07:29&lt;00:00,  2.78it/s]



    Epoch: 6/100, Train Loss: 0.31392360, Train Accuracy: 91.59779099, Val Loss: 0.48469237, Val Accuracy: 89.81020477


    100%|██████████| 2507/2507 [07:20&lt;00:00,  5.69it/s]
    100%|██████████| 1253/1253 [07:38&lt;00:00,  2.73it/s]



    Epoch: 7/100, Train Loss: 0.29900573, Train Accuracy: 91.90570577, Val Loss: 0.46181227, Val Accuracy: 90.14836721


    100%|██████████| 2507/2507 [07:35&lt;00:00,  5.51it/s]
    100%|██████████| 1253/1253 [07:41&lt;00:00,  2.71it/s]



    Epoch: 8/100, Train Loss: 0.29431356, Train Accuracy: 92.06277971, Val Loss: 0.45976700, Val Accuracy: 89.70538689


    100%|██████████| 2507/2507 [07:14&lt;00:00,  5.77it/s]
    100%|██████████| 1253/1253 [07:27&lt;00:00,  2.80it/s]


    Epoch: 9/100, Train Loss: 0.28652644, Train Accuracy: 92.23481307, Val Loss: 0.47067098, Val Accuracy: 90.02982318
</code></pre>
<h2 id="inference">Inference</h2>

<p>Next, we have defined some helper functions for inference. <code class="language-html highlighter-rouge">process_inputs</code> - process input image and return box proposals and image as pytorch tensors.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="n">normalized_transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
                                                        <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_selections</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">section_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)):</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">ximgproc</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">createSelectiveSearchSegmentation</span><span class="p">()</span>
    <span class="n">ss</span><span class="p">.</span><span class="n">setBaseImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">ss</span><span class="p">.</span><span class="n">switchToSelectiveSearchQuality</span><span class="p">()</span>
    <span class="n">rects</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">process</span><span class="p">()[:</span><span class="n">max_selections</span><span class="p">]</span>
    <span class="n">rects</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">rect</span>
        <span class="n">img_section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="n">x2</span><span class="p">]</span>
        <span class="n">img_section</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_section</span><span class="p">,</span> <span class="n">section_size</span><span class="p">)</span>
        <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_section</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">normalized_transform</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="non-max-supression">Non Max Supression</h3>

<p>Non Maximum Suppression is a computer vision method that selects a single bounding boxes from many overlapping bounding boxes in object detection. The criteria is usually discarding entities that are below a given probability bound.</p>

<p><img src="/assets/blogs/rcnn/img_6.png" alt="image.png" /></p>

<blockquote>
  <p><a href="https://paperswithcode.com/method/non-maximum-suppression">Reference</a></p>
</blockquote>

<p><img src="/assets/blogs/rcnn/img_7.png" alt="image.png" /></p>

<blockquote>
  <p><a href="https://pjreddie.com/darknet/yolov1/">Reference</a></p>
</blockquote>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">non_max_supression</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">chossen_boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">choosen_boxes_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">choosen_boxes_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">):</span>
        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">choosen_idx</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">last</span><span class="p">]</span>
        <span class="n">choosen_box</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">choosen_idx</span><span class="p">]</span>
        <span class="n">choosen_box_score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">choosen_idx</span><span class="p">]</span>
        <span class="n">choosen_box_label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">choosen_idx</span><span class="p">]</span>
        <span class="n">chossen_boxes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">choosen_box</span><span class="p">)</span>
        <span class="n">choosen_boxes_scores</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">choosen_box_score</span><span class="p">)</span>
        <span class="n">choosen_boxes_labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">choosen_box_label</span><span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">curr_box</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">curr_box_score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">curr_box_label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">curr_box_label</span> <span class="o">==</span> <span class="n">choosen_box_label</span> <span class="ow">and</span>
                <span class="n">calculate_iou_score</span><span class="p">(</span><span class="n">curr_box</span><span class="p">,</span> <span class="n">choosen_box</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iou_threshold</span><span class="p">):</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">chossen_boxes</span><span class="p">,</span> <span class="n">choosen_boxes_scores</span><span class="p">,</span> <span class="n">choosen_boxes_labels</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">process_outputs</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="n">probas</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">final_boxes</span><span class="p">,</span> <span class="n">final_boxes_scores</span><span class="p">,</span> <span class="n">final_boxes_labels</span> <span class="o">=</span> <span class="n">non_max_supression</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">probas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_boxes</span><span class="p">,</span> <span class="n">final_boxes_scores</span><span class="p">,</span> <span class="n">final_boxes_labels</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next we load best model checkpoints.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="c1"># loading best model
</span><span class="n">model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">"rcnn_model.pt"</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="nt">&lt;All</span> <span class="na">keys</span> <span class="na">matched</span> <span class="na">successfully</span><span class="nt">&gt;</span>
</code></pre></div></div>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">val_image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">voc_dataset_val</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># preprocess input image
</span><span class="n">prep_val_images</span><span class="p">,</span> <span class="n">prep_val_boxes</span> <span class="o">=</span> <span class="n">process_inputs</span><span class="p">(</span><span class="n">val_image</span><span class="p">)</span>
<span class="n">prep_val_images</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">prep_val_images</span><span class="p">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">prep_val_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">prep_val_boxes</span><span class="p">.</span><span class="n">dtype</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>(torch.Size([300, 3, 224, 224]), torch.float32, (300, 4), dtype('int32'))
</code></pre></div></div>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">prep_val_images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
<span class="c1"># postprocess output from model
</span><span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">boxes</span><span class="p">,</span> <span class="n">boxes_scores</span><span class="p">,</span> <span class="n">boxes_labels</span> <span class="o">=</span> <span class="n">process_outputs</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">prep_val_boxes</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="n">final_image</span> <span class="o">=</span> <span class="n">draw_boxes</span><span class="p">(</span><span class="n">val_image</span><span class="p">,</span>
                         <span class="n">boxes</span><span class="p">,</span>
                         <span class="n">boxes_scores</span><span class="p">,</span>
                         <span class="n">boxes_labels</span><span class="p">,</span>
                         <span class="n">idx_2_label</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/assets/blogs/rcnn/output_69_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">only_boxed_image</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_boxes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1"># preprocess input image
</span>    <span class="n">prep_val_images</span><span class="p">,</span> <span class="n">prep_val_boxes</span> <span class="o">=</span> <span class="n">process_inputs</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_selections</span><span class="o">=</span><span class="n">max_boxes</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">prep_val_images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
    <span class="c1"># postprocess output from model
</span>    <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">boxes</span><span class="p">,</span> <span class="n">boxes_scores</span><span class="p">,</span> <span class="n">boxes_labels</span> <span class="o">=</span> <span class="n">process_outputs</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span>
                                                        <span class="n">prep_val_boxes</span><span class="p">,</span>
                                                        <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                        <span class="n">iou_threshold</span><span class="o">=</span><span class="n">iou_threshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only_boxed_image</span><span class="p">:</span>
        <span class="n">box_image</span> <span class="o">=</span> <span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">boxes_scores</span><span class="p">,</span> <span class="n">boxes_labels</span><span class="p">,</span> <span class="n">label_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">box_image</span>
    <span class="k">return</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">boxes_scores</span><span class="p">,</span> <span class="n">boxes_labels</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">voc_dataset_val</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">final_image</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">only_boxed_image</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">label_map</span><span class="o">=</span><span class="n">idx_2_label</span><span class="p">,</span>
                          <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/assets/blogs/rcnn/output_71_0.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_1.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_2.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_3.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_4.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_5.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_6.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_7.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_8.png" alt="png" /></p>

<p><img src="/assets/blogs/rcnn/output_71_9.png" alt="png" /></p>

<h2 id="exercise-todo">Exercise ToDo</h2>
<ul>
  <li>Make <code class="language-html highlighter-rouge">process_data_for_rcnn</code> function to use multiprocessing using <code class="language-html highlighter-rouge">Joblib</code> module. <em>Joblib</em> module in Python is used to execute tasks parallelly using Pipelines rather than executing them sequentially one after another.</li>
  <li>How we can postprocess these outputs more better?</li>
</ul>

<h2 id="important-links">Important Links</h2>
<ul>
  <li><a href="/assets/blogs/rcnn/RCNN_Demo_Pytorch.ipynb">Download Python Notebook</a></li>
  <li><a href="https://youtu.be/y8eTUtpC-Gk">Youtube Video</a></li>
</ul>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://arxiv.org/abs/1311.2524">Rich feature hierarchies for accurate object detection and semantic segmentation
</a></li>
  <li><a href="https://pyimagesearch.com/2020/06/29/opencv-selective-search-for-object-detection/">OpenCV Selective Search for Object Detection by Adrian Rosebrock</a></li>
  <li><a href="https://medium.com/dataseries/understanding-selective-search-for-object-detection-3f38709067d7">Understanding Selective Search for Object Detection</a></li>
</ul>

		</div>
		<div class="post-tags">
			<ul>
				
					<li>machine-learning</li>
				
					<li>deep-learning</li>
				
					<li>object-detection</li>
				
					<li>rcnn</li>
				
					<li>pytorch</li>
				
			</ul>
		</div>
		
	</div>
	<div class="container">
		
	</div>
</section>

    <section class="social">
    <ul animation="fade-down" animation-time="1s">
        <li><a target="_blank" href="https://twitter.com/tarunresearches"><i class="fab fa-twitter"></i></a></li>
        <li><a target="_blank" href="https://www.instagram.com/tarunresearches"><i class="fab fa-instagram"></i></a></li>
        <li><a target="_blank" href="https://www.linkedin.com/in/tarunbisht"><i class="fab fa-linkedin-in"></i></a></li>
        <li><a target="_blank" href="https://www.kaggle.com/tarunbisht11"><i class="fab fa-kaggle"></i></a></li>
        <li><a target="_blank" href="https://github.com/tarun-bisht"><i class="fab fa-github"></i></a></li>
        <li><a target="_blank" href="https://medium.com/@iamtarunbisht"><i class="fab fa-medium-m"></i></a></li>
        <li><a target="_blank" href="https://www.youtube.com/channel/UCSxE20aTc9IJFF3ZQb1cbLA"><i class="fab fa-youtube"></i></a></li>
    </ul>
</section>
    <footer>
  <div class="image"></div>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about/">About</a></li>
      <li><a href="/blogs/"> Blogs</a></li>
      <li><a href="/projects/">Projects</a></li>
      <li><a href="/resume/">Resume</a></li>
      <li><a href="/cv/">Academic CV</a></li>
      <li><a href="/contact/">Contact</a></li>
      
    </ul>
  </nav>
  <div class="copyright">
    Copyright © 2025 All rights reserved
  </div>
</footer>

    

<script src="/assets/js/production.min.js"></script>
<script src="/assets/js/app.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
</body>
</html>